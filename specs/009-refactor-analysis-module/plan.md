# Implementation Plan: Refactor Analysis Module Report Generator

**Branch**: `009-refactor-analysis-module` | **Date**: 2025-10-28 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/009-refactor-analysis-module/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command.

## Summary

**Primary Requirement**: Eliminate hardcoded metric lists in `src/analysis/report_generator.py` and implement fully dynamic, config-driven report generation using MetricsConfig singleton.

**Technical Approach**: 
1. Remove hardcoded `RELIABLE_METRICS` set and all string literal metric identifiers
2. Refactor MetricsConfig API to provide unified `get_all_metrics()` instead of separate subsection methods
3. Implement auto-discovery pattern: partition metrics into "with data" vs "without data" at generation time by scanning run files
4. Replace permissive `.get()` calls with strict validation helpers (`_require_config_value()`)
5. Migrate configuration format from 3 subsections (reliable/derived/excluded) to single unified metrics section
6. Generate limitations section dynamically based on which metrics have no collected data

## Technical Context

**Language/Version**: Python 3.11+  
**Primary Dependencies**: PyYAML (config), pytest (testing), existing codebase (no new external deps)  
**Storage**: File-based (YAML configs, JSON run data)  
**Testing**: pytest with integration tests for report generation  
**Target Platform**: Linux/macOS/Windows (cross-platform Python)  
**Project Type**: Single project (refactoring existing analysis module)  
**Performance Goals**: Report generation <30 seconds for 50 runs across 3 frameworks  
**Constraints**: 
- Must maintain backward compatibility with experiment run data schema
- Breaking change acceptable for config format (one-time migration)
- Zero runtime dependencies beyond existing requirements.txt
**Scale/Scope**: 
- ~2800 lines in report_generator.py to refactor
- ~400 lines in metrics_config.py to modify
- 16 functional requirements across 3 user stories

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Verify compliance with BAEs Experiment Constitution v1.2.0:

- [x] **Scientific Reproducibility**: Report generation is deterministic (fixed order, no random sampling). No impact on seed/version management.
- [x] **Clarity & Transparency**: All refactored functions will have docstrings. Config changes documented in migration guide.
- [x] **Open Science**: No new dependencies. All code remains CC BY 4.0.
- [x] **Minimal Dependencies**: Using only PyYAML (already in requirements.txt). No new packages added.
- [x] **Deterministic HITL**: N/A - This is code refactoring, not framework interaction changes.
- [x] **Reproducible Metrics**: No changes to metrics collection. Only affects reporting/formatting.
- [x] **Version Control Integrity**: N/A - No framework version changes.
- [x] **Automation-First**: Report generation remains fully automated via existing CLI.
- [x] **Failure Isolation**: Each run remains isolated. Config validation improves error detection.
- [x] **Educational Accessibility**: Improved code clarity through removal of hardcoded values. Enhanced docs.
- [x] **DRY Principle**: Eliminates duplicated metric lists. Centralizes all definitions in MetricsConfig.
- [x] **No Backward Compatibility Burden**: Config format breaking change is acceptable (documented migration path).
- [x] **Fail-Fast Philosophy**: Replacing `.get()` with `_require_config_value()` enforces fail-fast validation.

**Constitution Alignment**: ✅ **FULL COMPLIANCE**  
All refactoring aligns with constitution. Breaking config change (principle XII) is justified by improved maintainability. Fail-fast validation (principle XIII) is central goal of this feature.

## Project Structure

### Documentation (this feature)

```
specs/009-refactor-analysis-module/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (configuration patterns, validation strategies)
├── data-model.md        # Phase 1 output (MetricsConfig API design)
├── quickstart.md        # Phase 1 output (migration guide for users)
└── contracts/           # Phase 1 output (MetricsConfig API contracts)
    ├── metrics_config_api.md
    └── report_generator_api.md
```

### Source Code (repository root)

```
src/
├── analysis/
│   ├── report_generator.py       # REFACTOR: Remove hardcoded metrics, add validation
│   ├── stopping_rule.py          # MINOR: Update to use new MetricsConfig API
│   └── visualization_factory.py  # MINOR: Update to use new MetricsConfig API
├── utils/
│   ├── metrics_config.py         # REFACTOR: Simplify API, unified metrics section
│   └── logger.py                 # NO CHANGE: Existing logger used for validation errors
└── config_sets/
    └── models.py                 # REVIEW: Check if ConfigSet needs updates

tests/
├── unit/
│   ├── test_metrics_config.py    # NEW: Unit tests for new MetricsConfig API
│   ├── test_report_validation.py # NEW: Unit tests for fail-fast validation
│   └── test_metric_discovery.py  # NEW: Unit tests for auto-discovery logic
└── integration/
    ├── test_report_generation.py # UPDATE: Test complete report flow with new config
    └── test_config_migration.py  # NEW: Test old → new format migration

config/
└── experiment.yaml               # UPDATE: Migrate to new unified metrics format (if exists)

config_sets/
├── default/
│   └── experiment_template.yaml  # UPDATE: Add unified metrics section
└── minimum/
    └── experiment_template.yaml  # UPDATE: Add unified metrics section

docs/
└── CONFIG_MIGRATION_GUIDE.md     # NEW: Step-by-step migration instructions
```

**Structure Decision**: Single project refactoring. All changes concentrated in `src/analysis/` and `src/utils/` with supporting test infrastructure. Configuration migration requires one-time update to `config/experiment.yaml`.

## Implementation Sequence

### Phase 1: MetricsConfig Refactoring
1. Update `src/utils/metrics_config.py`:
   - Add format detection (_is_old_format())
   - Implement unified _parse_metrics()
   - Add get_all_metrics(), get_metrics_by_category()
   - Remove get_reliable/derived/excluded_metrics()
2. Add validation helpers (_require_config_value, _require_nested_config)
3. Add comprehensive error messages (ConfigMigrationError, ConfigValidationError)

### Phase 2: Report Generator Refactoring
1. Update `src/analysis/report_generator.py`:
   - Remove hardcoded RELIABLE_METRICS set (line 609)
   - Add _discover_metrics_with_data()
   - Add _generate_limitations_section()
   - Update _generate_executive_summary() to use discovery
   - Update _generate_metric_table_from_config() to filter by data
   - Replace all .get() calls with _require_config_value()
2. Add MetricsDiscoveryResult dataclass

### Phase 3: Testing
1. Create unit tests:
   - test_metrics_config.py: New API methods, format detection, validation
   - test_report_validation.py: Fail-fast helpers, error messages
   - test_metric_discovery.py: Auto-discovery algorithm, partitioning
2. Create integration tests:
   - test_report_generation.py: End-to-end with new format
   - test_config_migration.py: Old format rejection

### Phase 4: Migration
1. Create `docs/CONFIG_MIGRATION_GUIDE.md`
2. Update config files to new format:
   - `config/experiment.yaml` (if exists)
   - `config_sets/default/experiment_template.yaml`
   - `config_sets/minimum/experiment_template.yaml`
3. Update `quickstart.md` with examples (already complete)
4. Update minor dependents (stopping_rule.py, visualization_factory.py)

### Phase 5: Validation & Documentation
1. Run full test suite
2. Generate sample report with new config
3. Verify limitations section auto-generated
4. Update README.md with migration notice

**Critical Path**: Phase 1 → Phase 2 → Phase 3 (tests validate refactoring)

**Risk Mitigation**: Unit tests written alongside refactoring to catch regressions immediately.

## Complexity Tracking

**No Constitution Violations** - All 13 principles validated in Constitution Check section above.

This table only applies if violations exist. Current implementation fully complies with BAEs Constitution v1.2.0.
